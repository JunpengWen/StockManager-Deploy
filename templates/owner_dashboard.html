<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Owner Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <style>
        /* Comprehensive multi-store styling */
        .store-card { transition: transform 0.2s; border: 1px solid #dee2e6; }
        .store-card:hover { transform: translateY(-5px); box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        .metric-item { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px solid #eee; }
        .metric-label { font-weight: 500; color: #666; }
        .metric-value { font-weight: 600; color: #333; }
        .store-actions { display: grid; gap: 8px; grid-template-columns: 1fr 1fr; }
        #storeSwitch { max-width: 300px; margin-left: auto; }
        .category-group { border-left: 3px solid #0d6efd; padding-left: 1rem; margin-bottom: 1.5rem; }
        .category-header { color: #0d6efd; font-weight: 500; }
        .accordion-button:not(.collapsed) { background-color: #f8f9fa; }
        .badge { min-width: 30px; }
        .table th { font-weight: 500; background-color: #f8f9fa; }
        #checklistStoreFilter { border: 2px solid #0d6efd; }
        .stock-status-indicator { width: 20px; height: 20px; border-radius: 50%; }
        .status-safe { background-color: #28a745; }
        .status-warning { background-color: #ffc107; }
        .status-critical { background-color: #dc3545; }
        #storeSummary { font-size: 0.9rem; opacity: 0.8; }
        .navbar { border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .nav-link { transition: all 0.2s ease; }
        .nav-link.active-context { background-color: rgba(255,255,255,0.15); border-radius: 4px; }
        .dropdown-menu { border: 1px solid rgba(0,0,0,0.15); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .bi-shop, .bi-gear { margin-right: 8px; }
        @media (max-width: 991.98px) {
            .navbar-nav { margin-top: 12px; }
            .dropdown-menu { border: none; box-shadow: none; }
        }
        /* 在 <style> 区块添加 */
        .low-stock-card {
            border-left: 4px solid #dc3545;
            transition: all 0.3s ease;
        }
        .low-stock-card:hover {
            transform: translateX(5px);
            box-shadow: 0 2px 8px rgba(220,53,69,0.3);
        }
        .stock-metric {
            font-size: 0.9em;
            padding: 8px 12px;
            background: #fff5f5;
            border-radius: 6px;
        }
        .warning-item .text-muted span {
            display: inline-block;
            margin-right: 1rem;
            min-width: 160px;
        }
        .warning-item .text-danger {
            min-width: 140px;
        }
        .bi {
            margin-right: 0.3rem;
        }
        #ownerHistoryBody tr:hover {
            background-color: #f8f9fa;
            transition: background-color 0.2s ease;
        }

        .table-responsive {
            max-height: 500px;
            overflow-y: auto;
        }
        .table th {
            vertical-align: middle;
            text-align: center;
        }
        .table td {
            text-align: center;
            vertical-align: middle;
        }
        .dropdown-menu {

            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.1);
        }

        #currentStoreBadge,
        #currentCategoryBadge {
            font-size: 0.9em;
            vertical-align: middle;
            margin-left: 0.5rem;
        }
        #editAllowedCategories{
            max-height:220px;
            overflow-y:auto;
        }
    </style>
</head>

<body data-user-role="{{ session.role }}"
      data-valid-stores="{{ valid_stores|tojson|safe }}"
      data-current-store="{{ selected_store or '' }}">
    <div class="container mt-5">
        <!-- Navigation -->
        <nav class="navbar navbar-expand-lg navbar-dark bg-primary mb-4">
            <div class="container-fluid">
                <a class="navbar-brand" href="#">Multi-Store Navigation</a>
                <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#ownerNav">
                    <span class="navbar-toggler-icon"></span>
                </button>
                <div class="collapse navbar-collapse" id="ownerNav">
                    <ul class="navbar-nav me-auto">

                    </ul>
                    <ul class="navbar-nav">
                        <li class="nav-item dropdown">
                            <a class="nav-link dropdown-toggle" href="#" id="managementDropdown" role="button"
                               data-bs-toggle="dropdown" aria-expanded="false">
                                <i class="bi bi-gear"></i> Management
                            </a>
                            <ul class="dropdown-menu dropdown-menu-end">
                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="showAddItemForm()">
                                    <i class="bi bi-plus-circle"></i> Add Inventory Item</a></li>
                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="showEditCategoryForm()">
                                    <i class="bi bi-tags"></i> Manage Categories</a></li>
                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="showEditSupplierForm()">
                                    <i class="bi bi-truck"></i> Manage Suppliers</a></li>
                                <li><a class="dropdown-item" href="javascript:void(0)"
                                       onclick="loadAccountManagement()">
                                    <i class="bi bi-people"></i> User Accounts</a>
                                </li>
                                <li> <a class="dropdown-item" href="javascript:void(0)" onclick="showEditUnitForm()">
                                    <i class="bi bi-rulers"></i> Manage Units </a>
                                </li>
                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="showEditStoreForm()">
                                    <i class="bi bi-shop"></i> Manage Stores
                                </a></li>

                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="showSettingAccountForm()">
                                    <i class="bi bi-person-plus"></i> Create New Account</a></li>
                            </ul>
                        </li>
                    </ul>
                </div>
            </div>
        </nav>

        <div id="contextUpdateError" class="alert alert-danger d-none mb-3"></div>



        <!-- 找到现有的 Add Inventory Item 模态框，修改为以下内容 -->
        <div class="modal fade" id="addItemModal" tabindex="-1" aria-labelledby="addItemModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="addItemModalLabel">Add New Inventory Item</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="addItemForm" onsubmit="handleAddItem(event)">
                        <div class="modal-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Item Name</label>
                                    <input type="text" class="form-control" id="itemName" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Category</label>
                                    <select class="form-select" id="itemCategory" required>
                                        <option value="">Loading categories...</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Max Stock Level</label>
                                    <input type="number" min="0" class="form-control" id="maxStock" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">In-Stock Level</label>
                                    <input type="number" min="0" class="form-control" id="inStock" required>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Reorder Level</label>
                                    <input type="number" min="0" class="form-control" id="reorderLevel" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Store Selection</label>
                                    <select class="form-select store-select" id="itemStore" required>
                                        <option value="all">All Stores</option>
                                        {% for store in valid_stores %}
                                        <option value="{{ store }}">{{ store.split(',')[0] }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Supplier</label>
                                    <select class="form-select supplier-select" id="addItemSupplier" required>
                                        <option value="">Loading suppliers...</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Unit (optional)</label>
                                    <select class="form-select unit-select" id="itemUnit">
                                        <option value="">-- Select Unit --</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <div class="alert alert-warning mt-2">
                                        <i class="bi bi-exclamation-triangle"></i>
                                        Reorder Level must be less than Max Stock Level
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                            <button type="submit" class="btn btn-primary">Add Item</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Create Account Modal -->
        <div class="modal fade" id="createAccountModal" tabindex="-1" aria-labelledby="createAccountModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-lg">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="createAccountModalLabel">Create New Account</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <form id="createAccountForm" onsubmit="createNewAccount(event)">
                        <div class="modal-body">
                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label class="form-label">Username</label>
                                    <input type="text" class="form-control" id="createUsername" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Role</label>
                                    <select class="form-select" id="createRole" required>
                                        <option value="employee">Employee</option>
                                        <option value="manager">Manager</option>
                                        <option value="owner">Owner</option>
                                        <option value="server">Server</option>
                                        <option value="line_cook">Line Cook</option>
                                        <option value="prep_cook">Prep Cook</option>
                                    </select>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Employee Name</label>
                                    <input type="text" class="form-control" id="createEmployeeName" required>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Store</label>
                                    <select class="form-select store-select" id="createStoreAddress" required>
                                        {% for store in valid_stores %}
                                        <option value="{{ store }}">{{ store.split(',')[0] }}</option>
                                        {% endfor %}
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Phone</label>
                                    <input type="tel" class="form-control" id="createPhone" required>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Email</label>
                                    <input type="email" class="form-control" id="createEmail" required>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Password</label>
                                    <input type="password" class="form-control" id="createPassword" required>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                            <button type="submit" class="btn btn-primary">Create Account</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Pending Authorization -->
        <div class="card p-3 mb-3">
            <h3>Pending Authorization</h3>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Role</th>
                        <th>Employee</th>
                        <th>Store</th>
                        <th>Phone</th>
                        <th>Email</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="pendingTableBody">
                    <tr id="emptyRow">
                        <td colspan="7" class="text-center text-muted">No pending requests</td>
                    </tr>
                </tbody>
            </table>
        </div>



        <!-- Stock Warnings -->
        <div class="card p-3 mb-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Multi/Store Stock Warnings</h3>
                <div class="d-flex align-items-center gap-3">
                    <button class="btn btn-danger" onclick="downloadMultiStoreReport()">
                        <i class="bi bi-file-earmark-pdf"></i> Download Report
                    </button>
                    <select class="form-select store-select" id="warningStoreFilter" onchange="fetchStockWarnings()">
                        <option value="all">All Stores</option>
                        {% for store in valid_stores %}
                        <option value="{{ store }}">{{ store.split(',')[0] }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <div id="warningListContainer" class="accordion"></div>
        </div>

        <!-- Inventory Checklist -->
        <div class="card p-3 mb-3">
            <h3>Multi/Store Inventory Checklist</h3>
            <div class="row g-3">
                <div class="col-md-6">
                    <label class="form-label">Store</label>
                    <select class="form-select store-select" id="checklistStoreFilter" onchange="loadStoreCategories(this.value)">
                        <option value="all">All Stores</option>
                        {% for store in valid_stores %}
                        <option value="{{ store }}">{{ store.split(',')[0] }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-6">
                    <label class="form-label">Category</label>
                    <select class="form-select" id="ownerCategoryDropdown" onchange="loadStoreItems()" disabled>
                        <option value="">Loading...</option>
                    </select>
                </div>
            </div>
            <div id="multiStoreItemSection" class="mt-3 d-none">
                <div class="table-responsive">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Category</th>
                                <th>Stock</th>
                                <th>Status</th>
                                <th>Updated</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="multiStoreItemList"></tbody>
                    </table>
                </div>
            </div>

            <div class="row justify-content-end mt-3">
                <div class="col-auto position-relative">
                    <!-- Add 按钮和下拉菜单 -->
                    <button class="btn btn-primary dropdown-toggle"
                            id="inlineAddBtn"
                            data-bs-toggle="dropdown"
                            aria-expanded="false">
                        <i class="bi bi-plus-lg"></i> Add Item
                    </button>

                    <div class="dropdown-menu p-3" aria-labelledby="inlineAddBtn"
                         style="min-width: 400px;">
                        <form id="inlineAddForm" onsubmit="handleInlineAdd(event)">
                            <div class="mb-3">
                                <label class="form-label">Current Store:</label>
                                <span id="currentStoreBadge" class="badge bg-primary"></span>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Current Category:</label>
                                <span id="currentCategoryBadge" class="badge bg-primary"></span>
                            </div>

                            <div class="row g-3">
                                <div class="col-12">
                                    <input type="text" class="form-control"
                                           id="inlineItemName" required
                                           placeholder="Item Name">
                                </div>
                                <div class="col-md-6">
                                    <input type="number" class="form-control"
                                           id="inlineMaxStock" min="0" required
                                           placeholder="Max Stock">
                                </div>
                                <div class="col-md-6">
                                    <input type="number" class="form-control"
                                           id="inlineInStock" min="0" required
                                           placeholder="Current Stock">
                                </div>
                                <div class="col-md-6">
                                    <input type="number" class="form-control"
                                           id="inlineReorderLevel" min="0" required
                                           placeholder="Reorder Level">
                                </div>
                                <div class="mb-3">
                                    <label for="supplierSelect" class="form-label">Supplier</label>
                                    <select class="form-select supplier-select" id="supplierSelect" required>
                                        <option value="" disabled selected>-- Select Supplier --</option>
                                        <!-- 选项将通过JavaScript动态填充 -->
                                    </select>
                                </div>

                                <div class="col-md-6">
                                    <select class="form-select unit-select" id="inlineUnit">
                                        <option value="">-- Select Unit --</option>
                                    </select>
                                </div>
                            </div>

                            <div class="mt-3 d-flex justify-content-between">
                                <button type="button" class="btn btn-secondary"
                                        onclick="closeDropdown()">
                                    Close
                                </button>
                                <button type="submit" class="btn btn-success">
                                    <i class="bi bi-check-lg"></i> Add Item
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Account Management -->
        <div id="accountManagementSection" class="card p-3 mb-3 d-none">
            <h3>User Accounts</h3>
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Role</th>
                        <th>Employee</th>
                        <th>Store</th>
                        <th>Phone</th>
                        <th>Email</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="accountTableBody"></tbody>
            </table>
        </div>




        <!-- Store Date Report -->
        <div class="card p-3 mb-3">
            <h3>Store Date Report</h3>
            <div class="row g-3">
                <div class="col-md-4">
                    <label class="form-label">Store</label>
                    <select class="form-select" id="dateReportStoreFilter">
                        <option value="">Select Store</option>
                        {% for store in valid_stores %}
                        <option value="{{ store }}">{{ store.split(',')[0] }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label">Date</label>
                    <input type="date" class="form-control" id="dateReportDate" required>
                </div>
                <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <div>
                        <button class="btn btn-primary" onclick="generateStoreDateReport()">
                            <i class="bi bi-file-earmark-pdf"></i> Generate Report
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stock History -->
        <div class="card p-3">
            <h3>Stock Update History</h3>
            <div class="accordion" id="historyAccordion">
                <!-- Accordion items will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Edit Account Modals  -->
    <div class="modal fade" id="editAccountModal" tabindex="-1" aria-labelledby="editAccountModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editAccountModalLabel">Edit Account</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editAccountForm" onsubmit="saveAccountChanges(event)">
                    <div class="modal-body">
                        <input type="hidden" id="editAccountId">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Username</label>
                                <input type="text" class="form-control" id="editUsername" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Role</label>
                                <select class="form-select" id="editRole">
                                    <option value="employee">Employee</option>
                                    <option value="manager">Manager</option>
                                    <option value="owner">Owner</option>
                                    <option value="server">Server</option>
                                    <option value="line_cook">Line Cook</option>
                                    <option value="prep_cook">Prep Cook</option>
                                </select>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Full Name</label>
                                <input type="text" class="form-control" id="editEmployeeName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Store</label>
                                <select class="form-select store-select" id="editStoreAddress" required>
                                    {% for store in valid_stores %}
                                    <option value="{{ store }}">{{ store.split(',')[0] }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Phone</label>
                                <input type="tel" class="form-control" id="editPhone" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" id="editEmail" required>
                            </div>
                            <div class="col-12">
                                <label class="form-label">Current Password</label>
                                <input type="text" class="form-control" id="currentPassword" readonly>
                            </div>
                            <div class="col-12">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="editResetPassword">
                                    <label class="form-check-label" for="editResetPassword">
                                        Reset Password
                                    </label>
                                </div>
                            </div>
                            <div class="col-12 password-field d-none">
                                <label class="form-label">New Password</label>
                                <input type="password" class="form-control" id="editPassword">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Allowed Categories</label>
                                <div id="editAllowedCategories" class="d-flex flex-wrap gap-3">
                                    <!-- check-boxes will be injected by JS -->
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editItemModal" tabindex="-1" aria-labelledby="editItemModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editItemModalLabel">Edit Inventory Item</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <form id="editItemForm" onsubmit="saveItemChanges(event)">
                    <div class="modal-body">
                        <input type="hidden" id="editItemId">
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label">Item Name</label>
                                <input type="text" class="form-control" id="editItemName" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Store</label>
                                <select class="form-select store-select" id="editItemStore" {% if session.role != 'owner' %}disabled{% endif %} required>
                                    {% for store in valid_stores %}
                                    <option value="{{ store }}">{{ store.split(',')[0] }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Max Stock</label>
                                <input type="number" class="form-control" id="editMaxStock" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Current Stock</label>
                                <input type="number" class="form-control" id="editCurrentStock" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label">Reorder Level</label>
                                <input type="number" class="form-control" id="editReorderLevel" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Category</label>
                                <select class="form-select" id="editItemCategory" required></select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Supplier</label>
                                <select class="form-select supplier-select" id="editItemSupplier" required>
                                    <option value="">Loading suppliers...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Unit</label>
                                <select class="form-select unit-select" id="editItemUnit">
                                    <option value="">-- Select Unit --</option>
                                </select>
                            </div>

                        </div>
                        <div id="currentImagePreview" class="mt-3 text-center"></div>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                        <button type="submit" class="btn btn-primary">Save changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal fade" id="categoryModal" tabindex="-1" aria-labelledby="categoryModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="categoryModalLabel">Manage Categories</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="categoryList" class="mb-3">
                        <!-- Categories will be populated here -->
                    </div>
                    <div class="input-group">
                        <input type="text"
                               id="newCategory"
                               class="form-control"
                               placeholder="New category name"
                               aria-label="New category name"
                               aria-describedby="categoryAddButton">
                        <button class="btn btn-primary"
                                type="button"
                                id="categoryAddButton"
                                onclick="addCategory()">Add</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveCategories()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- 在categoryModal之后添加 -->
    <div class="modal fade" id="supplierModal" tabindex="-1" aria-labelledby="supplierModalLabel">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="supplierModalLabel">Manage Suppliers</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div id="supplierList" class="mb-3">
                        <!-- 供应商列表将在这里动态填充 -->
                    </div>
                    <div class="input-group">
                        <input type="text" id="newSupplier" class="form-control"
                               placeholder="New supplier name" aria-label="New supplier name">
                        <button class="btn btn-primary" type="button" id="supplierAddButton"
                                onclick="addSupplier()">Add</button>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="saveSuppliers()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- ── UNIT MANAGEMENT MODAL ────────────────────────────────────── -->
    <div class="modal fade" id="unitModal" tabindex="-1" aria-labelledby="unitModalLabel">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="unitModalLabel">Manage Units</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>

          <div class="modal-body">
            <!-- dynamic list of current units -->
            <div id="unitList" class="mb-3"></div>

            <!-- add-new input -->
            <div class="input-group">
              <input id="newUnit" class="form-control" placeholder="New unit (e.g. tray)">
              <button class="btn btn-primary" onclick="addUnit()">Add</button>
            </div>
          </div>

          <div class="modal-footer">
            <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            <button class="btn btn-primary" onclick="saveUnits()">Save Changes</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ── STORE MANAGEMENT MODAL ────────────────────────── -->
    <div class="modal fade" id="storeModal" tabindex="-1" aria-labelledby="storeModalLabel">
      <div class="modal-dialog"><div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="storeModalLabel">Manage Stores</h5>
          <button class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div id="storeList" class="mb-3"></div>
          <div class="input-group">
            <input id="newStore" class="form-control" placeholder="Full address">
            <button class="btn btn-primary" onclick="addStore()">Add</button>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          <button class="btn btn-primary" onclick="saveStores()">Save Changes</button>
        </div>
      </div></div>
    </div>





    <!--  exit section -->
    <div class="mt-3 text-center">
        <button class="btn btn-danger" onclick="confirmExit()">Exit System</button>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        function formatWithUnit(value, unit) {
            return unit ? `${value} ${unit}` : value;
        }

        document.addEventListener('DOMContentLoaded', initializeStores);


        // 添加成功提示函数
        function showSuccessAlert(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success position-fixed top-0 end-0 m-3';
            alertDiv.innerHTML = `
                <i class="bi bi-check-circle-fill"></i>
                ${message}
            `;
            document.body.appendChild(alertDiv);
            setTimeout(() => alertDiv.remove(), 2000);
        }
        function closeDropdown() {
            const dropdown = bootstrap.Dropdown.getOrCreateInstance(
                document.getElementById('inlineAddBtn')
            );
            dropdown.hide();
        }



        // 在现有的脚本代码中添加以下函数
        async function showAddItemForm() {
             await initializeStores();
            // 加载类别数据
            const categorySelect = document.getElementById('itemCategory');
            categorySelect.innerHTML = '<option value="">Loading categories...</option>';

            try {
                const response = await fetch('/categories');
                const categories = await response.json();
                categorySelect.innerHTML = categories.map(c =>
                        `<option value="${c}">${c}</option>`
                ).join('');
            } catch (error) {
                categorySelect.innerHTML = `<option value="">Error loading categories</option>`;
            }

            // 清除现有值 - 使用正确的ID
            ['itemName', 'maxStock', 'inStock', 'reorderLevel', 'addItemSupplier'].forEach(id => {
                const field = document.getElementById(id);
                if (field) field.value = ''; // Add null check
            });

            // 显示模态框
            new bootstrap.Modal(document.getElementById('addItemModal')).show();
        }

        async function handleAddItem(event) {
            event.preventDefault();
            const addItemModal = document.getElementById('addItemModal');

            // Clear previous errors and states
            document.querySelectorAll('.is-invalid').forEach(el => el.classList.remove('is-invalid'));
            document.querySelectorAll('.invalid-feedback').forEach(el => el.remove());

            const itemData = {
                name: document.getElementById('itemName').value.trim(),
                category: document.getElementById('itemCategory').value,
                max_stock_level: parseInt(document.getElementById('maxStock').value),
                in_stock_level: parseInt(document.getElementById('inStock').value),
                reorder_level: parseInt(document.getElementById('reorderLevel').value),
                supplier_id: parseInt(document.getElementById('addItemSupplier').value, 10),
                unit: document.getElementById('itemUnit').value,
                store_address: document.getElementById('itemStore').value
            };

            // Frontend validation
            if (itemData.reorder_level >= itemData.max_stock_level) {
                showFieldError('reorderLevel', 'Reorder Level must be less than Max Stock Level');
                return;
            }

            try {
                // Show loading state for "all stores" operations
                const isAllStores = itemData.store_address === 'all';
                if (isAllStores) {
                    const submitBtn = addItemModal.querySelector('button[type="submit"]');
                    const originalText = submitBtn.innerHTML;
                    submitBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Adding to all stores...';
                    submitBtn.disabled = true;
                }
                
                const response = await fetch('/owner_dashboard', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(itemData)
                });

                const result = await response.json();

                if (!response.ok) {
                    handleBackendError(response.status, result.message);
                    return;
                }

                // Success handling - use the detailed message from backend
                showSuccessAlert(result.message || 'Item added successfully!');
                bootstrap.Modal.getInstance(addItemModal).hide();
                event.target.reset();
                initializeStores();
                loadStoreItems();
                
                // Restore button state if it was changed
                if (isAllStores) {
                    const submitBtn = addItemModal.querySelector('button[type="submit"]');
                    submitBtn.innerHTML = 'Add Item';
                    submitBtn.disabled = false;
                }

            } catch (error) {
                handleNetworkError(error);
                // Restore button state on error
                if (isAllStores) {
                    const submitBtn = addItemModal.querySelector('button[type="submit"]');
                    submitBtn.innerHTML = 'Add Item';
                    submitBtn.disabled = false;
                }
            }

            function showFieldError(fieldId, message) {
                const field = document.getElementById(fieldId);
                const errorDiv = document.createElement('div');
                errorDiv.className = 'invalid-feedback d-block mt-1';
                errorDiv.textContent = message;
                field.parentNode.appendChild(errorDiv);
                field.classList.add('is-invalid');
            }

            function handleBackendError(status, message) {
                if (status === 409) {
                    showFieldError('itemName', `${message} - Update existing item instead?`);
                    keepModalOpen();
                } else {
                    showGenericError(message || 'Failed to add item');
                }
                // Restore button state on error
                if (isAllStores) {
                    const submitBtn = addItemModal.querySelector('button[type="submit"]');
                    submitBtn.innerHTML = 'Add Item';
                    submitBtn.disabled = false;
                }
            }

            function handleNetworkError(error) {
                console.error('Add item error:', error);
                showGenericError('Network error - please check your connection');
                keepModalOpen();
                // Restore button state on error
                if (isAllStores) {
                    const submitBtn = addItemModal.querySelector('button[type="submit"]');
                    submitBtn.innerHTML = 'Add Item';
                    submitBtn.disabled = false;
                }
            }

            function showGenericError(message) {
                const errorDiv = document.createElement('div');
                errorDiv.className = 'alert alert-danger mt-3';
                errorDiv.innerHTML = `
                    <i class="bi bi-exclamation-triangle"></i>
                    ${message}
                `;
                addItemModal.querySelector('.modal-body').prepend(errorDiv);
            }

            function showSuccessAlert(message) {
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success mt-3';
                alertDiv.innerHTML = `
                    <i class="bi bi-check-circle"></i>
                    ${message}
                `;
                addItemModal.querySelector('.modal-body').prepend(alertDiv);
                setTimeout(() => bootstrap.Modal.getInstance(addItemModal).hide(), 1500);
            }

            function keepModalOpen() {
                const modal = bootstrap.Modal.getInstance(addItemModal);
                if (modal) modal.handleUpdate();
            }
        }

        // 新增的添加功能逻辑
        function handleInlineAdd(e) {
            e.preventDefault();

            // 获取当前选择的store和category
            const storeAddress = document.getElementById('checklistStoreFilter').value;
            const category = document.getElementById('ownerCategoryDropdown').value;

            // 获取supplier值 - 修改这里
            const supplierSelect = document.getElementById('supplierSelect');

            const supplierId = supplierSelect.value || null

            const itemData = {
                name: document.getElementById('inlineItemName').value.trim(),
                max_stock_level: parseInt(document.getElementById('inlineMaxStock').value),
                in_stock_level: parseInt(document.getElementById('inlineInStock').value),
                reorder_level: parseInt(document.getElementById('inlineReorderLevel').value),
                supplier_id: supplierId,  // 使用supplier_id而不是supplier name
                unit : document.getElementById('inlineUnit').value,
                store_address: storeAddress,
                category: category
            };

            // 验证逻辑
            if ([storeAddress, category].some(v => !v)) {
                alert('Please select Store and Category first');
                return;
            }

            if (itemData.reorder_level >= itemData.max_stock_level) {
                alert('Reorder Level must be less than Max Stock');
                return;
            }
            if (!supplierId) {
                alert('Please choose a Supplier first');
                return;
            }

            // 发送请求
            fetch('/owner_dashboard', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(itemData)
            })
            .then(response => {
                if (!response.ok) throw new Error(response.statusText);
                // 清空表单并关闭下拉
                document.getElementById('inlineAddForm').reset();

                // 刷新列表
                loadStoreItems();
                showSuccessAlert('Item added successfully!');
                // 保留下拉菜单显示
                const dropdown = bootstrap.Dropdown.getOrCreateInstance(
                    document.getElementById('inlineAddBtn')
                );
                dropdown.show(); // 确保下拉保持展开
            })
            .catch(error => {
                alert('Add failed: ' + error.message);
                // 错误时保持下拉展开
                const dropdown = bootstrap.Dropdown.getOrCreateInstance(
                    document.getElementById('inlineAddBtn')
                );
                dropdown.show();
            });
        }

        // 动态更新当前选中的Store和Category
        document.getElementById('checklistStoreFilter').addEventListener('change', updateBadges);
        document.getElementById('ownerCategoryDropdown').addEventListener('change', updateBadges);

        function updateBadges() {
            document.getElementById('currentStoreBadge').textContent =
                document.getElementById('checklistStoreFilter').value.split(',')[0] || 'Not selected';
            document.getElementById('currentCategoryBadge').textContent =
                document.getElementById('ownerCategoryDropdown').value || 'Not selected';
        }

        // 修改初始化按钮有效性检查的代码
        document.getElementById('inlineAddBtn').addEventListener('click', function () {
            const storeValue      = document.getElementById('checklistStoreFilter').value;
            const categoryValue   = document.getElementById('ownerCategoryDropdown').value;

            /*  Only the category is mandatory now.
                We accept  a concrete store  OR  "all". */
            if (categoryValue === '') {
                alert('Please select a Category first');
                return;
            }

            /*  Update the badges (“Current Store / Category”) and
                open the dropdown menu as normal. */
            updateBadges();
        });



        // 批准账户
        async function approveAccount(accountId) {
            try {
                const response = await fetch(`/authorize_account/${accountId}`, {method: 'POST'});
                if (!response.ok) throw new Error('Authorization failed');
                // 同时刷新待审列表和已授权用户列表
                await Promise.all([
                    loadPendingAccounts(),
                    loadAccountManagement() // 新增此行
                ]);
                alert('Account authorized successfully');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // 拒绝账户
        async function rejectAccount(accountId) {
            if (!confirm('Are you sure you want to reject this account?')) return;

            try {
                const response = await fetch(`/reject_account/${accountId}`, {method: 'POST'});
                if (!response.ok) throw new Error('Rejection failed');
                loadPendingAccounts(); // 刷新列表
                alert('Account rejected successfully');
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // 修改后的loadPendingAccounts函数
        async function loadPendingAccounts() {
            const tbody = document.getElementById('pendingTableBody');

            try {
                // 显示加载状态
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Loading pending accounts...</td></tr>';

                const response = await fetch('/pending_accounts');
                if (!response.ok) throw new Error('Failed to fetch accounts');
                const accounts = await response.json();

                // 清空加载状态
                tbody.innerHTML = '';

                if (accounts.length > 0) {
                    tbody.innerHTML = accounts.map(account => `
                        <tr>
                            <td>${account.username}</td>
                            <td>${account.role}</td>
                            <td>${account.employee_name || 'N/A'}</td>
                            <td>${account.store_address.split(',')[0]}</td>
                            <td>${account.phone_number}</td>
                            <td>${account.email}</td>
                            <td class="pending-actions">
                                <button class="btn btn-sm btn-success"
                                    onclick="approveAccount(${account.id})">
                                    <i class="bi bi-check-circle"></i> Approve
                                </button>
                                <button class="btn btn-sm btn-danger ms-2"
                                    onclick="rejectAccount(${account.id})">
                                    <i class="bi bi-x-circle"></i> Reject
                                </button>
                            </td>
                        </tr>
                    `).join('');
                } else {
                    // 这里完全动态生成空状态内容
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="7" class="text-center text-muted py-3">
                                <i class="bi bi-info-circle me-2"></i>
                                No accounts pending authorization
                            </td>
                        </tr>`;
                }
            } catch (error) {
                // 错误提示也改成全动态生成
                tbody.innerHTML = `
                    <tr class="text-danger">
                        <td colspan="7">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Error loading pending accounts: ${error.message}
                        </td>
                    </tr>`;
            }
        }

        // 添加账户管理加载函数
        async function loadAccountManagement() {
            const section = document.getElementById('accountManagementSection');
            const tbody = document.getElementById('accountTableBody');

            try {
                // 强制显示账户管理区域
                section.classList.remove('d-none');
                tbody.innerHTML = '<tr><td colspan="7" class="text-center">Loading account data...</td></tr>';

                // 获取账户数据
                const response = await fetch('/accounts');
                const data = await response.json();

                // 根据角色过滤显示数据
                const currentStore = document.getElementById('checklistStoreFilter').value;
                const filteredAccounts = currentStore === 'all' ?
                        data.authorized_accounts :
                        data.authorized_accounts.filter(acc =>
                                acc.store_address === currentStore
                        );

                // 填充表格
                tbody.innerHTML = filteredAccounts.map(account => `
                    <tr>
                        <td>${account.username}</td>
                        <td>${account.role}</td>
                        <td>${account.employee_name || 'N/A'}</td>
                        <td>${account.store_address.split(',')[0]}</td>
                        <td>${account.phone_number}</td>
                        <td>${account.email}</td>
                        <td>
                            <button class="btn btn-sm btn-warning"
                                    onclick="openEditModal(${account.id})">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-danger ms-2"
                                    onclick="deleteAccount(${account.id})">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                `).join('');

            } catch (error) {
                tbody.innerHTML = `
                    <tr class="text-danger">
                        <td colspan="7">
                            <i class="bi bi-exclamation-triangle me-2"></i>
                            Error loading account data: ${error.message}
                        </td>
                    </tr>`;
            }
        }

        // 添加删除账户函数
        async function deleteAccount(accountId) {
            if (!confirm('Are you sure you want to delete this account?')) return;

            try {
                const response = await fetch(`/accounts`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({id: accountId})
                });

                if (response.ok) {
                    loadAccountManagement();
                    alert('Account deleted successfully');
                } else {
                    throw new Error(await response.text());
                }
            } catch (error) {
                alert('Delete failed: ' + error.message);
            }
        }

        // 显示供应商管理模态框
        async function showEditSupplierForm() {
            try {
                const response = await fetch('/suppliers');
                const suppliers = await response.json();

                const supplierList = document.getElementById('supplierList');
                supplierList.innerHTML = suppliers.map(supplier => `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${supplier.name}</span>
                        <button class="btn btn-sm btn-danger"
                                onclick="deleteSupplier(${supplier.id})">
                            &times;
                        </button>
                    </div>
                `).join('');

                new bootstrap.Modal(document.getElementById('supplierModal')).show();
            } catch (error) {
                console.error('Error loading suppliers:', error);
                alert('Error loading suppliers');
            }
        }

        // 添加新供应商
        function addSupplier() {
            const newSupplier = document.getElementById('newSupplier').value.trim();
            if (newSupplier) {
                const supplierList = document.getElementById('supplierList');
                supplierList.innerHTML += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${newSupplier}</span>
                        <button class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">&times;</button>
                    </div>
                `;
                document.getElementById('newSupplier').value = '';
            }
        }

        // 保存供应商
        function saveSuppliers() {
            const suppliers = Array.from(document.querySelectorAll('#supplierList span'))
                .map(span => span.textContent);

            fetch('/suppliers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ suppliers })
            })
            .then(response => {
                if (response.ok) {
                    alert('Suppliers updated successfully!');
                    document.getElementById('supplierModal').querySelector('.btn-close').click();
                    // 刷新供应商选择器
                    initializeSuppliers();
                }
            })
            .catch(error => {
                alert('Failed to save suppliers: ' + error.message);
            });
        }


        // 在DOM加载完成后初始化
        document.addEventListener('DOMContentLoaded', initializeSuppliers);

        async function deleteSupplier(supplierId) {
            if (!confirm('Are you sure you want to delete this supplier?')) return;

            try {
                const response = await fetch(`/suppliers/${supplierId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    // 重新加载供应商列表
                    await showEditSupplierForm();
                    // 重新初始化下拉菜单
                    await initializeSuppliers();
                } else {
                    throw new Error('Failed to delete supplier');
                }
            } catch (error) {
                console.error('Error deleting supplier:', error);
                alert('Error deleting supplier: ' + error.message);
            }
        }

        // 显示创建账户弹窗
        function showSettingAccountForm() {
            // 清空表单
            document.getElementById('createUsername').value = '';
            document.getElementById('createRole').value = 'employee';
            document.getElementById('createEmployeeName').value = '';
            document.getElementById('createStoreAddress').value = '{{ valid_stores[0] }}';
            document.getElementById('createPhone').value = '';
            document.getElementById('createEmail').value = '';
            document.getElementById('createPassword').value = '';

            // 显示弹窗
            new bootstrap.Modal(document.getElementById('createAccountModal')).show();
        }

        // 处理表单提交
        async function createNewAccount(e) {
            e.preventDefault();

            const formData = {
                username: document.getElementById('createUsername').value,
                role: document.getElementById('createRole').value,
                employee_name: document.getElementById('createEmployeeName').value,
                store_address: document.getElementById('createStoreAddress').value,
                phone_number: document.getElementById('createPhone').value,
                email: document.getElementById('createEmail').value,
                password: document.getElementById('createPassword').value
            };

            try {
                const response = await fetch('/create_account', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(formData)
                });

                if (response.ok) {
                    alert('Account created successfully!');
                    window.location.reload();
                } else {
                    const error = await response.json();
                    alert('Error: ' + error.message);
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function initializeSuppliers() {
            try {
                const response  = await fetch('/suppliers');
                const suppliers = await response.json();

                document.querySelectorAll('.supplier-select').forEach(select => {
                    const previouslySelected = select.value;   // ➊ remember choice
                    select.innerHTML =
                        '<option value="">-- Select Supplier --</option>' +
                        suppliers.map(s =>
                            `<option value="${s.id}">${s.name}</option>`
                        ).join('');
                    if (previouslySelected) {                  // ➋ restore it
                        select.value = previouslySelected;     // ➌
                    }
                });
                return suppliers;
            } catch (err) {
                console.error('Error initialising suppliers:', err);
                return [];
            }
        }

        async function saveAccountChanges(e){
            e.preventDefault();
            const id = document.getElementById('editAccountId').value;
            const selectedCategories = Array.from(
                document.querySelectorAll('#editAllowedCategories input[type=checkbox]:checked')
            ).map(cb => cb.value);

            const payload = {
                username        : document.getElementById('editUsername').value,
                role            : document.getElementById('editRole').value,
                employee_name   : document.getElementById('editEmployeeName').value,
                store_address   : document.getElementById('editStoreAddress').value,
                phone_number    : document.getElementById('editPhone').value,
                email           : document.getElementById('editEmail').value,
                password        : document.getElementById('editResetPassword').checked
                                  ? document.getElementById('editPassword').value : '',
                allowed_categories : selectedCategories
            };

            const res = await fetch(`/update_account/${id}`,{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify(payload)
            });
            if(res.ok){
                alert('Account saved!');
                loadAccountManagement();   // refresh table
                bootstrap.Modal.getInstance(
                   document.getElementById('editAccountModal')
                ).hide();
            }else{
                alert((await res.json()).message);
            }
        }


        // 添加角色感知的UI控制
        function setupRoleBasedUI() {
            const role = document.body.dataset.userRole;

            // 隐藏非授权功能
            if(role !== 'owner') {
                document.querySelectorAll('.owner-only').forEach(el => el.remove());
            }

            // 添加删除确认
            document.addEventListener('click', e => {
                if(e.target.closest('.btn-danger')) {
                    if(!confirm('确认执行此操作？')) e.preventDefault();
                }
            });
        }

        // 库存输入验证
        function validateStockInput() {
            const max = parseInt(document.getElementById('maxStock').value);
            const current = parseInt(document.getElementById('inStock').value);

            if(current > max) {
                alert('当前库存不能大于最大库存');
                return false;
            }
            return true;
        }


        async function openItemEditModal(itemId) {
            try {
                /* 1️⃣  Make sure the <select> already has every supplier option.
                       initializeSuppliers() populates *all* .supplier-select
                       elements once, including #editItemSupplier, and returns
                       an array of supplier objects.                           */
                const suppliers = await initializeSuppliers();   // leaves options intact

                /* 2️⃣  Fetch the item you want to edit                         */
                const res  = await fetch(`/items/${itemId}`);
                if (!res.ok) throw new Error('Failed to fetch item data');
                const item = await res.json();

                /* 3️⃣  Select the correct supplier in the already-filled list */
                const supplierSelect = document.getElementById('editItemSupplier');
                supplierSelect.value = item.supplier_id ? String(item.supplier_id) : '';

                /* 4️⃣  Fill the remaining fields                               */
                document.getElementById('editItemId').value        = item.id;
                document.getElementById('editItemName').value      = item.name        || '';
                document.getElementById('editItemStore').value     = item.store_address || '';
                document.getElementById('editMaxStock').value      = item.max_stock_level || 0;
                document.getElementById('editCurrentStock').value  = item.in_stock_level  || 0;
                document.getElementById('editReorderLevel').value  = item.reorder_level    || 0;
                document.getElementById('editItemUnit').value      = item.unit        || '';

                /* 5️⃣  Categories                                              */
                const categories  = await (await fetch('/categories')).json();
                const catSelect   = document.getElementById('editItemCategory');
                catSelect.innerHTML = categories.map(c =>
                    `<option value="${c}" ${c === item.category ? 'selected' : ''}>${c}</option>`
                ).join('');

                /* 6️⃣  Show the modal                                          */
                bootstrap.Modal.getOrCreateInstance(
                    document.getElementById('editItemModal')
                ).show();

            } catch (err) {
                console.error('Error loading item data:', err);
                alert('Error loading item data: ' + err.message);
            }
        }


        async function saveItemChanges(e) {
            e.preventDefault();                               // ⬅  keep page alive
            const modalEl   = document.getElementById('editItemModal');
            const modalInst = bootstrap.Modal.getInstance(modalEl);

            // 1️⃣ collect data
            const payload = {
                id              : +document.getElementById('editItemId').value,
                name            : document.getElementById('editItemName').value.trim(),
                max_stock_level : +document.getElementById('editMaxStock').value,
                in_stock_level  : +document.getElementById('editCurrentStock').value,
                reorder_level   : +document.getElementById('editReorderLevel').value,
                supplier_id     : +document.getElementById('editItemSupplier').value,
                category        : document.getElementById('editItemCategory').value,
                store_address   : document.getElementById('editItemStore').value,
                unit            : document.getElementById('editItemUnit').value
            };

            try {
                const r = await fetch(`/update_item/${payload.id}`,{
                    method :'POST',
                    headers:{'Content-Type':'application/json'},
                    body   : JSON.stringify(payload)
                });
                if (!r.ok){
                    const err = await r.json();
                    throw new Error(err.message || r.statusText);
                }

                /* 2️⃣  update visible rows (owner checklist, warnings, etc.) */
                applyItemPatch(payload);          // ← helper below

                /* 3️⃣  hide modal & toast */
                modalInst.hide();
                showSuccessAlert('Item updated!'); // your existing helper

                /* 4️⃣  refresh warnings in the background (optional) */
                fetchStockWarnings();

            } catch(err){
                alert(`Update failed: ${err.message}`);
            }
        }

        /* Helper that rewrites every <tr data-item-id="…"> that is currently
           in the DOM – so the change is shown wherever the table is visible.      */
        function applyItemPatch(it){
            document.querySelectorAll(`tr[data-item-id="${it.id}"]`).forEach(tr=>{
                const cols = tr.children;
                /* owner checklist table order:
                   0-Name 1-Category 2-Stock 3-Status 4-Updated 5-Actions */
                if (cols.length >= 5){
                    cols[0].textContent = it.name;
                    cols[1].textContent = it.category;
                    cols[2].textContent = formatWithUnit(it.in_stock_level, it.unit);

                    const badge = cols[3].querySelector('.badge');
                    badge.className = `badge ${getStockStatusClass(it)}`;
                    badge.textContent = getStockStatusText(it);

                    cols[4].textContent = new Date().toLocaleDateString();
                }

                /* manager table order differs – add similar updates if needed */
            });
        }


        let cachedSuppliers = null;

        async function getSuppliers() {
            if (cachedSuppliers) return cachedSuppliers;

            try {
                const response = await fetch('/suppliers');
                cachedSuppliers = await response.json();
                return cachedSuppliers;
            } catch (error) {
                console.error('Error fetching suppliers:', error);
                return [];
            }
        }

        async function showEditCategoryForm() {
            const response = await fetch('/categories');
            const categories = await response.json();
            const categoryList = document.getElementById('categoryList');

            categoryList.innerHTML = categories.map(c => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>${c}</span>
                    <button class="btn btn-sm btn-danger" onclick="deleteCategory('${c}')">&times;</button>
                </div>
            `).join('');

            new bootstrap.Modal(document.getElementById('categoryModal')).show();
        }

        async function addCategory() {
            const newCategory = document.getElementById('newCategory').value.trim();
            if (newCategory) {
                const categoryList = document.getElementById('categoryList');
                categoryList.innerHTML += `
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <span>${newCategory}</span>
                        <button class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">&times;</button>
                    </div>
                `;
                document.getElementById('newCategory').value = '';
            }
        }

        async function saveCategories() {
            const categories = Array.from(document.querySelectorAll('#categoryList span'))
                .map(span => span.textContent);

            try {
                const response = await fetch('/categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categories })
                });

                if (response.ok) {
                    alert('Categories updated successfully!');
                    document.getElementById('categoryModal').querySelector('.btn-close').click();
                }
            } catch (error) {
                alert('Failed to save categories: ' + error.message);
            }
        }



        // Event listeners
        document.getElementById('editResetPassword').addEventListener('change', function() {
            document.querySelector('.password-field').classList.toggle('d-none', !this.checked);
        });



        // Initialize categories in add item form
        async function initializeCategories() {
            const response = await fetch('/categories');
            const categories = await response.json();
            document.querySelectorAll('.category-select').forEach(select => {
                select.innerHTML = categories.map(c => `<option value="${c}">${c}</option>`).join('');
            });
        }

        document.addEventListener('DOMContentLoaded', initializeCategories);

        // Global state
        let currentStoreContext = 'all';
        let currentCategories = [];

        // Store Management
        async function updateStoreContext(storeAddress) {
            const header = document.querySelector('.navbar-brand');
            const storeStatusElement = document.getElementById('currentStore');

            // Safe element update
            if (storeStatusElement) {
                storeStatusElement.textContent = storeAddress.split(',')[0] || 'All Stores';
            }

            try {
                // Clear previous data first
                document.getElementById('multiStoreItemList').innerHTML = '<tr><td colspan="6">Loading...</td></tr>';

                // Load dependent systems
                await Promise.all([
                    fetchStockWarnings(),
                    loadStoreCategories(storeAddress),
                    loadPendingAccounts(),
                    loadAccountManagement()
                ]);

            } catch (error) {
                console.error('Error updating store context:', error);
                // Show error in UI
                const errorElement = document.getElementById('contextUpdateError');
                if (errorElement) {
                    errorElement.textContent = `Error: ${error.message}`;
                }
            }
        }



        // Stock Warnings
        async function fetchStockWarnings() {
            const storeFilter = document.getElementById('warningStoreFilter').value;
            const warningContainer = document.getElementById('warningListContainer');

            try {
                const url = storeFilter === 'all'
                        ? '/items'
                        : `/items?store=${encodeURIComponent(storeFilter)}`;

                const response = await fetch(url, {
                    credentials: 'include' // Include session cookies
                });
                const items = await response.json();

                // 自动包含统计信息
                const stats = {
                    totalItems: items.length,
                    lowStockCount: items.filter(i => i.in_stock_level <= i.reorder_level).length,
                    lastUpdated: new Date().toLocaleString()
                };

                // 创建分组结构
                const groupedItems = items
                        .filter(item => item.in_stock_level <= item.reorder_level)
                        .reduce((acc, item) => {
                            const storeKey = storeFilter === 'all' ? item.store_address : storeFilter;
                            if (!acc[storeKey]) acc[storeKey] = {};
                            if (!acc[storeKey][item.category]) acc[storeKey][item.category] = [];
                            acc[storeKey][item.category].push(item);
                            return acc;
                        }, {});

                warningContainer.innerHTML = `
                        <div class="alert alert-info">
                            Total Items: ${stats.totalItems} |
                            Low Stock Items: ${stats.lowStockCount} |
                            Last Updated: ${stats.lastUpdated}
                        </div>
                    `;

                // Clear existing content first
                warningContainer.innerHTML = '';

                // Build accordion items for each store
                for (const [storeKey, categories] of Object.entries(groupedItems)) {
                    const storeName = storeKey.split(',')[0];
                    const categoryItems = [];

                    // Build category sections
                    for (const [category, items] of Object.entries(categories)) {
                        categoryItems.push(`
                            <div class="category-group mb-4">
                                <h5>${category}</h5>
                                ${items.map(item => `
                                <div class="warning-item d-flex justify-content-between align-items-center p-2 border-bottom">
                                <div class="w-75">
                                <div class="fw-bold">${item.name}</div>
                                            <div class="text-muted small">
                                                <span class="me-3">
                                                    <i class="bi bi-box-seam"></i>
                                                    Current: ${formatWithUnit(item.in_stock_level, item.unit)}
                                                </span>
                                                <span class="me-3">
                                                    <i class="bi bi-exclamation-triangle"></i>
                                                    Reorder: ${formatWithUnit(item.reorder_level, item.unit)}
                                                </span>
                                                <span class="me-3">
                                                    <i class="bi bi-boxes"></i>
                                                    Max: ${formatWithUnit(item.max_stock_level, item.unit)}
                                                </span>
                                                <span class="text-danger fw-bold">
                                                    <i class="bi bi-cart-plus"></i>
                                                        Restock: ${formatWithUnit(item.max_stock_level - item.in_stock_level,
                                                                                    item.unit)}
                                                </span>
                                            </div>
                                        </div>

                                    </div>
                                `).join('')
                    }
                </div>
                    `);
                    }

                    // Create the full accordion item
                    warningContainer.innerHTML += `
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button" type="button"
                                        data-bs-toggle="collapse"
                                        data-bs-target="#collapse-${storeName.replace(/\s+/g, '-')}">
                                    ${storeName} ( Warnings )
                                </button>
                            </h2>
                            <div id="collapse-${storeName.replace(/\s+/g, '-')}"
                                 class="accordion-collapse collapse ">
                                <div class="accordion-body">
                                    ${categoryItems.join('')}
                                </div>
                            </div>
                        </div>
                    `;
                }

            } catch (error) {
                console.error('Error fetching warnings:', error);
                warningContainer.innerHTML = `
                    <div class="alert alert-danger">
                        Error loading warnings: ${error.message}
                    </div>
                `;
            }
        }

        // Add safety checks for critical elements
        document.addEventListener('DOMContentLoaded', () => {
            if (!document.getElementById('warningListContainer')) {
                console.error('Warning container element not found');
            }

            if (!document.getElementById('warningStoreFilter')) {
                console.error('Store filter element not found');
            }
        });

        function renderWarningItem(item) {
            return `
                <div class="warning-item d-flex justify-content-between align-items-center p-2">
                    <div>${item.name} (Current: ${item.in_stock_level})</div>
                    <button class="btn btn-sm btn-outline-primary"
                            onclick="openItemEditModal(${item.id})">
                        Edit
                    </button>

                </div>`;
        }



        // Checklist & Inventory Management
        async function loadStoreCategories(storeAddr) {
            const catSelect = document.getElementById('ownerCategoryDropdown');
            catSelect.disabled  = true;
            catSelect.innerHTML = '<option value="">Loading…</option>';

            try {
                const res   = await fetch(`/items?store=${encodeURIComponent(storeAddr)}`);
                const items = await res.json();
                let   cats  = [...new Set(items.map(i => i.category))].filter(Boolean);

                /* Fallback: use master list if the store is still empty */
                if (cats.length === 0) {
                    cats = await (await fetch('/categories')).json();
                }
                catSelect.innerHTML = cats.map(c =>
                    `<option value="${c}">${c}</option>`
                ).join('');
                catSelect.disabled = false;

                loadStoreItems();
            } catch (err) {
                console.error('Category load error:', err);
                catSelect.innerHTML = '<option value="">Error loading categories</option>';
            }
        }


        async function loadStoreItems() {
            const storeAddress = document.getElementById('checklistStoreFilter').value;
            const category = document.getElementById('ownerCategoryDropdown').value;

            try {
                const url = storeAddress === 'all'
                    ? '/items'
                    : `/items?store=${encodeURIComponent(storeAddress)}`;
                const response = await fetch(url);
                const items = await response.json();
                const filteredItems = category ? items.filter(item => item.category === category) : items;

                const tbody = document.getElementById('multiStoreItemList');
                if (!tbody) {
                    console.error('Inventory table body not found');
                    return;
                }
                tbody.innerHTML = filteredItems.map(item => `
                    <tr data-item-id="${item.id}">
                        <td>${item.name}</td>
                        <td>${item.category}</td>
                        <td>${formatWithUnit(item.in_stock_level, item.unit)}</td>
                        <td>
                            <span class="badge ${getStockStatusClass(item)}">
                                ${getStockStatusText(item)}
                            </span>
                        </td>
                        <td>${new Date().toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-sm btn-primary"
                                    onclick="openItemEditModal(${item.id})">
                                Edit
                            </button>
                            <button class="btn btn-sm btn-danger ms-2"
                                    onclick="confirmDeleteItem(${item.id}, '${item.name.replace(/'/g, "\\'")}')">
                                            Delete
                            </button>
                        </td>
                    </tr>
                `).join('');

                document.getElementById('multiStoreItemSection').classList.remove('d-none');
            } catch (error) {
                console.error('Error loading items:', error);
            }
        }

        async function confirmDeleteItem(itemId, itemName) {
            if (!confirm(`Permanently delete "${itemName}" ? This cannot be undone!`))
            return;

            try {
                const response = await fetch(`/delete_item/${itemId}`, {
                    method: 'POST'
                });

                if (!response.ok) {
                    const contentType = response.headers.get('content-type');

                    if (contentType && contentType.includes('application/json')) {
                        const error = await response.json();
                        throw new Error(error.message);
                    } else {
                        const textError = await response.text();
                        throw new Error(`
                            Server error: ${textError}`);
                    }
                }

                const row = document.querySelector(`tr[data-item-id="${itemId}"]`);
                if (row) row.remove();
                alert('Item deleted successfully!');
            } catch (error) {
                console.error('Deletion error details:', error);
                alert(`
                            Deletion failed: ${error.message}`);
            }
        }



        // PDF Reports
        async function downloadMultiStoreReport() {
            try {
                const storeFilter = document.getElementById('warningStoreFilter').value;
                const response = await fetch(`/download_stock_report?store=${encodeURIComponent(storeFilter)}`);

                if (!response.ok) throw new Error('Failed to generate report');

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const storePart = storeFilter === 'all'
                        ? 'All_Stores'
                        : storeFilter.split(',')[0].replace(/\s+/g, '_');
                a.download = `Stock_Report_${storePart}_${new Date().toISOString().slice(0,10)}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
            } catch (error) {
                alert('Error generating report: ' + error.message);
            }
        }

        async function generateStoreDateReport() {
            try {
                const storeFilter = document.getElementById('dateReportStoreFilter').value;
                const reportDate = document.getElementById('dateReportDate').value;

                if (!storeFilter) {
                    alert('Please select a store');
                    return;
                }

                if (!reportDate) {
                    alert('Please select a date');
                    return;
                }

                const response = await fetch(`/download_store_date_report?store=${encodeURIComponent(storeFilter)}&date=${encodeURIComponent(reportDate)}`);

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.message || 'Failed to generate report');
                }

                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const storePart = storeFilter.split(',')[0].replace(/\s+/g, '_');
                a.download = `Store_Date_Report_${storePart}_${reportDate}.pdf`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                alert('Error generating report: ' + error.message);
            }
        }

        // Initialization
        document.addEventListener('DOMContentLoaded', async () => {
            try {

                // Get store filter elements from the actual HTML
                const storeFilter = document.getElementById('checklistStoreFilter');
                const warningFilter = document.getElementById('warningStoreFilter');
                const dateReportFilter = document.getElementById('dateReportStoreFilter');
                await initializeSuppliers();
                const urlParams = new URLSearchParams(window.location.search);
                const initialStore = urlParams.get('store') || 'all';

                // Set all filter dropdowns
                if (storeFilter) storeFilter.value = initialStore;
                if (warningFilter) warningFilter.value = initialStore;
                // Don't set date report filter to 'all' since it doesn't have that option
                if (dateReportFilter && initialStore !== 'all') dateReportFilter.value = initialStore;

                // Set today's date as default for date report
                const dateReportDate = document.getElementById('dateReportDate');
                if (dateReportDate) {
                    dateReportDate.value = new Date().toISOString().slice(0, 10);
                }

                // Load initial data
                await Promise.all([
                    fetchStockWarnings(),
                    loadStoreCategories(initialStore),
                    loadPendingAccounts(),
                    loadAccountManagement(),
                    loadOwnerHistory()
                ]);

            } catch (error) {
                console.error('Initialization error:', error);
            }
        });

        // Utility Functions
        function getStockStatusClass(item) {
            if (item.in_stock_level <= item.reorder_level) return 'bg-danger';
            if (item.in_stock_level <= (item.reorder_level + 5)) return 'bg-warning';
            return 'bg-success';
        }

        function getStockStatusText(item) {
            if (item.in_stock_level <= item.reorder_level) return 'Critical';
            if (item.in_stock_level <= (item.reorder_level + 5)) return 'Low';
            return 'Normal';
        }

        function manageStore(storeAddress) {
            sessionStorage.setItem('selectedStore', storeAddress);
            window.location.href = `/owner_dashboard?store=${encodeURIComponent(storeAddress)}`;
        }

        // Global Store Context Management
        const validStores = JSON.parse('{{ valid_stores|tojson|safe }}');



        function generateStoreCard(storeAddress, stats) {
            return `
                <div class="col-md-6 col-xl-4">
                    <div class="card store-card">
                        <div class="card-body">
                            <h5 class="card-title">${storeAddress.split(',')[0]}</h5>
                            <div class="store-metrics">
                                <div class="metric-item">
                                    <span class="metric-label">Total Items:</span>
                                    <span class="metric-value">${stats.totalItems}</span>
                                </div>
                                <div class="metric-item ${stats.lowStockItems > 0 ? 'text-danger' : ''}">
                                    <span class="metric-label">Low Stock:</span>
                                    <span class="metric-value">${stats.lowStockItems}</span>
                                </div>
                                <div class="metric-item">
                                    <span class="metric-label">Recent Updates:</span>
                                    <span class="metric-value">${stats.recentUpdates}</span>
                                </div>
                            </div>
                            <div class="store-actions mt-3">
                                <button class="btn btn-sm btn-primary"
                                        onclick="manageStore('${storeAddress}')">
                                    Manage Inventory
                                </button>
                                <button class="btn btn-sm btn-secondary"
                                        onclick="viewStoreReports('${storeAddress}')">
                                    View Reports
                                </button>
                            </div>
                        </div>
                    </div>
                </div>`;
        }

        // Stock Warnings System
        async function loadStockWarnings() {
        const warningContainer = document.getElementById('warningListContainer');
        warningContainer.innerHTML = '<div class="text-center">Loading warnings...</div>';

        try {
            const response = await fetch(`/items?store=${encodeURIComponent(currentStoreContext)}`);
            const items = await response.json();
            const warnings = items.filter(item => item.in_stock_level <= item.reorder_level);

            if (warnings.length === 0) {
                warningContainer.innerHTML = '<div class="alert alert-success">No stock warnings</div>';
                return;
            }

            const groupedWarnings = warnings.reduce((acc, item) => {
                const storeKey = currentStoreContext === 'all' ? item.store_address : 'current';
                if (!acc[storeKey]) acc[storeKey] = {};
                if (!acc[storeKey][item.category]) acc[storeKey][item.category] = [];
                acc[storeKey][item.category].push(item);
                return acc;
            }, {});

            warningContainer.innerHTML = Object.entries(groupedWarnings)
                .map(([store, categories]) => `
                    <div class="accordion-item">
                        <h2 class="accordion-header">
                            <button class="accordion-button" type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#collapse-${store.replace(/ /g, '-')}">
                                ${store.split(',')[0]} (${Object.values(categories).flat().length})
                            </button>
                        </h2>
                        <div id="collapse-${store.replace(/ /g, '-')}"
                             class="accordion-collapse collapse show">
                            <div class="accordion-body">
                                ${Object.entries(categories).map(([category, items]) => `
                                    <div class="category-group mb-4">
                                        <h5>${category}</h5>
                                        <div class="list-group">
                                            ${items.map(item => `
                                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                                    <div class="flex-grow-1">
                                                        <div class="fw-bold">${item.name}</div>
                                                        <div class="text-muted small">
                                                            <span class="d-inline-block me-3">
                                                                <i class="bi bi-box-seam"></i>
                                                                Current: ${formatWithUnit(item.in_stock_level, item.unit)}
                                                            </span>
                                                            <span class="d-inline-block me-3">
                                                                <i class="bi bi-exclamation-triangle"></i>
                                                                Reorder: ${formatWithUnit(item.reorder_level, item.unit)}
                                                            </span>
                                                            <span class="d-inline-block me-3">
                                                                <i class="bi bi-boxes"></i>
                                                                Max: ${formatWithUnit(item.max_stock_level, item.unit)}
                                                            </span>
                                                            <span class="text-danger fw-bold">
                                                                <i class="bi bi-cart-plus"></i>
                                                                    Restock: ${formatWithUnit(item.max_stock_level - item.in_stock_level,
                                                                                              item.unit)}
                                                            </span>
                                                        </div>
                                                    </div>
                                                    <div>

                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `).join('');
        } catch (error) {
            warningContainer.innerHTML = '<div class="alert alert-danger">Error loading warnings</div>';
        }
    }

        // Inventory Checklist System
        async function loadChecklistItems() {
            const section = document.getElementById('multiStoreItemSection');
            const tbody = document.getElementById('multiStoreItemList');
            section.classList.add('d-none');
            tbody.innerHTML = '<tr><td colspan="6" class="text-center">Loading...</td></tr>';

            try {
                const [itemsRes, categoriesRes] = await Promise.all([
                    fetch(`/items?store=${encodeURIComponent(currentStoreContext)}`),
                    fetch('/categories')
                ]);

                const items = await itemsRes.json();
                const categories = await categoriesRes.json();

                // Update Category Filter
                const categoryDropdown = document.getElementById('ownerCategoryDropdown');
                categoryDropdown.innerHTML = `
                    <option value="">All Categories</option>
                    ${categories.map(c => `<option value="${c}">${c}</option>`).join('')}
                `;
                categoryDropdown.disabled = false;

                // Populate Items Table
                tbody.innerHTML = items.map(item => `
                    <tr data-item-id="${item.id}">
                        <td>${item.name}</td>
                        <td>${item.category}</td>
                        <td>${formatWithUnit(item.in_stock_level, item.unit)}</td>
                        <td>
                            <span class="badge ${getStockStatusClass(item)}">
                                ${getStockStatusText(item)}
                            </span>
                        </td>
                        <td>${new Date(item.updated_at).toLocaleDateString()}</td>
                        <td>
                            <button class="btn btn-sm btn-primary"
                                    onclick="openItemEditModal(${item.id})">
                                Edit
                            </button>
                        </td>
                    </tr>
                `).join('');

                section.classList.remove('d-none');
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="6" class="text-danger">Error loading items</td></tr>';
            }
        }

        async function openEditModal(accountId) {
            try {
                // 1. 获取账户数据
                const response = await fetch(`/account/${accountId}`);
                const account = await response.json();
                const allCats = await (await fetch('/categories')).json();

                // 2. 填充模态框表单
                document.getElementById('editAccountId').value = account.id;
                document.getElementById('editUsername').value = account.username;
                document.getElementById('editRole').value = account.role;
                document.getElementById('editEmployeeName').value = account.employee_name;
                document.getElementById('editStoreAddress').value = account.store_address;
                document.getElementById('editPhone').value = account.phone_number;
                document.getElementById('editEmail').value = account.email;
                document.getElementById('currentPassword').value = account.password;


                const boxArea = document.getElementById('editAllowedCategories');
                boxArea.innerHTML = allCats.map(cat=>`
                    <div class="form-check">
                        <input  class="form-check-input"
                                type="checkbox"
                                id="allow_${cat}"
                                value="${cat}"
                                ${account.allowed_categories.includes(cat) ? 'checked':''}>
                        <label class="form-check-label" for="allow_${cat}">
                            ${cat}
                        </label>
                    </div>
                `).join('');

               // 4. 显示模态框
                const editModal = new bootstrap.Modal(document.getElementById('editAccountModal'));
                editModal.show();

            } catch (error) {
                console.error('Error loading account data:', error);
                alert('Error loading account data: ' + error.message);
            }
        }

        async function loadAuthorizedAccounts() {
            const tbody = document.getElementById('accountTableBody');
            tbody.innerHTML = '<tr><td colspan="7" class="text-center">Loading...</td></tr>';

            try {
                const response = await fetch('/accounts');
                const { authorized_accounts } = await response.json();

                tbody.innerHTML = authorized_accounts.map(account => `
                    <tr>
                        <td>${account.username}</td>
                        <td>${account.role}</td>
                        <td>${account.employee_name}</td>
                        <td>${account.store_address.split(',')[0]}</td>
                        <td>${account.phone_number}</td>
                        <td>${account.email}</td>
                        <td>
                            <button class="btn btn-sm btn-warning"
                                    onclick="openEditModal(${account.id})">
                                Edit
                            </button>
                            <button class="btn btn-sm btn-danger"
                                    onclick="deleteAccount(${account.id})">
                                Delete
                            </button>
                        </td>
                    </tr>
                `).join('');

                document.getElementById('accountManagementSection').classList.remove('d-none');
            } catch (error) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-danger">Error loading accounts</td></tr>';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const initialStore = urlParams.get('store') || sessionStorage.getItem('selectedStore') || 'all';

        });

        document.getElementById('warningStoreFilter').addEventListener('change', function() {
            currentStoreContext = this.value;
            loadStockWarnings();
        });

        document.getElementById('checklistStoreFilter').addEventListener('change', function() {
            currentStoreContext = this.value;
            loadChecklistItems();
        });

        async function deleteCategory(categoryName) {
            if (!confirm(`Delete category "${categoryName}"? This will remove it from all items!`)) return;

            try {
                // Fetch current categories from server
                const response = await fetch('/categories');
                const currentCategories = await response.json();

                // Remove the deleted category from the list
                const updatedCategories = currentCategories.filter(c => c !== categoryName);

                // Update global categories
                const updateResponse = await fetch('/categories', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ categories: updatedCategories })
                });

                if (!updateResponse.ok) throw new Error('Failed to update categories');

                // Refresh the category list UI
                await showEditCategoryForm();

                // Update all category selectors
                document.querySelectorAll('.category-select').forEach(select => {
                    select.innerHTML = updatedCategories.map(c =>
                        `<option value="${c}">${c}</option>`
                    ).join('');
                });

                alert(`Category "${categoryName}" deleted successfully`);

            } catch (error) {
                console.error('Delete category error:', error);
                alert(`Failed to delete category: ${error.message}`);
            }
        }

        // Add to modal initialization logic
        document.getElementById('categoryModal').addEventListener('hidden.bs.modal', () => {
            const mainContent = document.querySelector('.container');
            mainContent.setAttribute('tabindex', '-1');
            mainContent.focus();
            mainContent.removeAttribute('tabindex');
        });

        // Update DOMContentLoaded handler
        document.addEventListener('DOMContentLoaded', () => {
            // Delegated store context listener
            document.body.addEventListener('change', e => {
                if (e.target.matches('#checklistStoreFilter, #warningStoreFilter')) {
                    currentStoreContext = e.target.value;
                    updateStoreContext(currentStoreContext);
                }
            });

            // Initialize store context with null check
            const storeSwitch = document.getElementById('storeSwitch');
            if (storeSwitch) {
                const initialStore = new URLSearchParams(window.location.search).get('store') || 'all';
                storeSwitch.value = initialStore;
                updateStoreContext(initialStore);
            }
        });

        const editResetPassword = document.getElementById('editResetPassword');
        if (editResetPassword) { // Check element exists
            editResetPassword.addEventListener('change', function() {
                document.querySelector('.password-field').classList.toggle('d-none', !this.checked);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('checklistStoreFilter').addEventListener('change', function() {
                // Clear previous category selection when store changes
                document.getElementById('ownerCategoryDropdown').selectedIndex = 0;
                loadStoreCategories(this.value);
            });
        });

        document.addEventListener('DOMContentLoaded', () => {
            const storeFilter = document.getElementById('checklistStoreFilter');
            if (storeFilter) {
                storeFilter.addEventListener('change', function() {
                    loadStoreCategories(this.value);
                });
            }

            // Initial load
            if (storeFilter && storeFilter.value) {
                loadStoreCategories(storeFilter.value);
            }
        });

        async function deleteSingleRecord(recordId) {
            if (!confirm('Are you sure you want to delete this record?')) return;

            try {
                const response = await fetch(`/delete_stock_update/${recordId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.message.includes('Stock update batch deleted successfully')) {
                        loadOwnerHistory(); // Reload history data
                    }
                } else {
                    const error = await response.json();
                    showHistoryError(error.message || 'Failed to delete record');
                }
            } catch (error) {
                showHistoryError('Network Error: ' + error.message);
            }
        }

        function showHistoryError(message) {
            const errorDiv = document.getElementById('contextUpdateError');
            errorDiv.textContent = message;
            errorDiv.classList.remove('d-none');
            setTimeout(() => errorDiv.classList.add('d-none'), 3000);
        }

        async function loadOwnerHistory() {
            try {
                const storeFilter = document.getElementById('checklistStoreFilter').value;
                const response = await fetch(`/stock_update_history?store=${encodeURIComponent(storeFilter)}`);

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

                const userHistoryList = await response.json();
                const accordionContainer = document.getElementById('historyAccordion');
                accordionContainer.innerHTML = ''; // 清空现有内容

                userHistoryList.forEach((userHistory, index) => {
                    const user = userHistory.username;
                    const collapseId = `userCollapse${index}`;

                    const accordionItem = document.createElement('div');
                    accordionItem.className = 'accordion-item';
                    accordionItem.innerHTML = `
                        <h2 class="accordion-header">
                            <button class="accordion-button"
                                    type="button"
                                    data-bs-toggle="collapse"
                                    data-bs-target="#${collapseId}">
                                ${user} (${userHistory.records.length} updates)
                            </button>
                        </h2>
                        <div id="${collapseId}" class="accordion-collapse collapse show">
                            <div class="accordion-body p-0">
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                                        <thead>
                    <tr>
                        <th>Date</th>
                        <th>Category</th>
                        <th>Store</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                ${userHistory.records.map(r=>`
                  <tr>
                    <td>${new Date(r.updated_at).toLocaleString()}</td>
                    <td>${r.category || 'N/A'}</td>
                    <td>${r.store_address.split(',')[0]}</td>
                    <td>
                        <button class="btn btn-sm btn-primary"
                                onclick="downloadComprehensiveUpdate('${r.store_address}',
                                                                      '${userHistory.username}',
                                                                      ${r.id},
                                                                      '${r.category || ''}')">
                            <i class="bi bi-file-earmark-pdf"></i> ${r.category || 'Category'}
                        </button>
                        <button class="btn btn-sm btn-outline-danger ms-1"
                                onclick="deleteSingleRecord(${r.id})">
                            <i class="bi bi-trash"></i>
                        </button>
                    </td>
                  </tr>`).join('')}
                </tbody>
                                    </table>
                            </div>
                    </div>
            </div>
                `;
                    accordionContainer.appendChild(accordionItem);
                });

            } catch (error) {
                console.error('Error loading history:', error);
                const errorDiv = document.getElementById('contextUpdateError');
                errorDiv.textContent = `Error loading history: ${error.message}`;
                errorDiv.classList.remove('d-none');
            }
        }

        /* ---------- STORE helpers (re-entrant-safe) ---------------- */
        async function initializeStores() {
            const res  = await fetch('/stores');
            const list = await res.json();                   //   ["Kusan … SJ",  "Kusan … Milpitas"]

            document.querySelectorAll('.store-select').forEach(sel => {
                const previous = sel.value;                  // remember user’s current choice

                /* rebuild the option list from scratch */
                let html = list.map(
                    s => `<option value="${s}">${s.split(',')[0]}</option>`
                ).join('');

                /* always offer the broadcast option first */
                html = `<option value="all">All Stores</option>` + html;

                sel.innerHTML = html;                        // replace the whole list
                if (previous) sel.value = previous;          // restore selection if still present
            });

            return list;
        }


        async function showEditStoreForm(){
            const stores = await initializeStores();
            const box = document.getElementById('storeList');
            box.innerHTML = stores.map(s=>`
                <div class="d-flex justify-content-between mb-2">
                   <span>${s}</span>
                   <button class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">&times;</button>
                </div>`).join('');
            new bootstrap.Modal(document.getElementById('storeModal')).show();
        }

        function addStore(){
            const v = document.getElementById('newStore').value.trim();
            if(!v) return;
            document.getElementById('storeList').insertAdjacentHTML('beforeend',`
                <div class="d-flex justify-content-between mb-2">
                   <span>${v}</span>
                   <button class="btn btn-sm btn-danger" onclick="this.parentElement.remove()">&times;</button>
                </div>`);
            document.getElementById('newStore').value='';
        }

        async function saveStores(){
            const stores = [...document.querySelectorAll('#storeList span')].map(s=>s.textContent);
            await fetch('/stores',{
                method:'POST',
                headers:{'Content-Type':'application/json'},
                body:JSON.stringify({stores})
            });
            await initializeStores();                         // refresh selects
            bootstrap.Modal.getInstance(document.getElementById('storeModal')).hide();
        }


        // Initialize history on page load
        document.addEventListener('DOMContentLoaded', () => {
            loadOwnerHistory();
        });
        async function downloadComprehensiveUpdate(store, employee, recordId, category){
            try{
                const url = `/download_comprehensive_update_report`
                          + `?record=${recordId}`
                          + `&store=${encodeURIComponent(store)}`
                          + `&employee=${encodeURIComponent(employee)}`
                          + `&category=${encodeURIComponent(category)}`;
                const r   = await fetch(url);
                if(!r.ok) throw new Error('Report generation failed');
                const blob = await r.blob();
                const a    = document.createElement('a');
                a.href      = URL.createObjectURL(blob);
                const sn    = store.split(',')[0].replace(/\s+/g,'_');
                const cat   = category.replace(/\s+/g,'_');
                a.download  = `${cat}_Update_${sn}.pdf`;
                document.body.appendChild(a);
                a.click();
                a.remove();
            }catch(e){ alert(e.message); }
        }



        /* ----------------------------------------------------
           UNIT helpers – mirrors Category/Supplier logic
        ---------------------------------------------------- */

        /* re-populate every <select class="unit-select"> */
        async function initializeUnits() {
            const res  = await fetch('/units');
            const list = await res.json();           // ["pcs","kg",…]
            document.querySelectorAll('.unit-select').forEach(sel => {
                const prev = sel.value;
                sel.innerHTML = '<option value="">-- Select Unit --</option>' +
                                list.map(u => `<option value="${u}">${u}</option>`).join('');
                if (prev) sel.value = prev;          // keep user’s unsaved choice
            });
            return list;
        }

        /* open the modal, fill current unit list */
        async function showEditUnitForm() {
            const units = await initializeUnits();   // ensures list is fresh
            const box   = document.getElementById('unitList');
            box.innerHTML = units.map(u => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>${u}</span>
                    <button class="btn btn-sm btn-danger"
                            onclick="this.parentElement.remove()">&times;</button>
                </div>`).join('');
            new bootstrap.Modal(document.getElementById('unitModal')).show();
        }

        /* add a tag inside the modal list */
        function addUnit() {
            const input = document.getElementById('newUnit');
            const v = input.value.trim();
            if (!v) return;
            document.getElementById('unitList').insertAdjacentHTML('beforeend', `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>${v}</span>
                    <button class="btn btn-sm btn-danger"
                            onclick="this.parentElement.remove()">&times;</button>
                </div>`);
            input.value = '';
        }

        /* POST the edited list back to the server */
        async function saveUnits() {
            const units = Array.from(document.querySelectorAll('#unitList span'))
                          .map(s => s.textContent);
            await fetch('/units', {
                method : 'POST',
                headers: { 'Content-Type': 'application/json' },
                body   : JSON.stringify({ units })
            });
            await initializeUnits();   // refresh all drop-downs
            bootstrap.Modal.getInstance(document.getElementById('unitModal')).hide();
        }

        /* call once on page load so selects aren’t empty */
        document.addEventListener('DOMContentLoaded', initializeUnits);



        // Refresh history when store filter changes
        document.getElementById('checklistStoreFilter').addEventListener('change', loadOwnerHistory);

        function confirmExit() {
            if (confirm('Are you sure you want to log out?')) {
                // Clear client-side storage
                sessionStorage.clear();
                // Redirect to logout endpoint
                window.location.href = '/logout';
            }
        }
    </script>
</body>
</html>